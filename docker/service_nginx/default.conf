# production & staging
server {
  listen 80 default_server;

  # アップロードファイルの最大ファイルサイズ
  client_max_body_size 10M;

  # Make site accessible from http://localhost/
  server_name localhost;

  location / {
    limit_req zone=perip burst=10 nodelay;

    # HTTP で来たアクセスを HTTPS にリダイレクト
    if ($http_x_forwarded_proto != https) {
      return 301 https://$host$request_uri;
      break;
    }

    proxy_pass http://service:3000;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }
}

# server {
#   listen 80;
#   server_name localhost.co.jp;
#   return 301 https://localhost.co.jp$request_uri;
# }

# development
server {
  listen 8000 default_server;

  # アップロードファイルの最大ファイルサイズ
  client_max_body_size 10M;

  # Make site accessible from http://localhost/
  server_name localhost;

  location / {
    limit_req zone=perip burst=100;

    proxy_pass http://service:3000;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }
}